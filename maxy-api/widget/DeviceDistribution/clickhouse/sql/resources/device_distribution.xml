<mapper namespace="devicedistribution">
  <select id="selectDeviceDistributionTroubleList">
    <![CDATA[
    SELECT
        log_tm AS logTm,
        device_id AS deviceId,
        user_id AS userId,
        log_type AS logType,
        os_type AS osType,
        app_ver AS appVer,
        logName AS logName,
        device_model AS deviceModel,
        mem_usage AS memUsage
    FROM maxy_app_trouble_log
    WHERE log_tm_dt >= toDateTime(%(from_ts)s)
      AND log_tm_dt <  toDateTime(%(to_ts)s)
      AND package_nm = %(package_nm)s
      AND server_type = %(server_type)s
      AND device_model = %(device_model)s
      AND (
            (log_type = %(crash_log_type)s AND %(trouble_type)s = %(crash_log_type)s)
         OR (log_type != %(crash_log_type)s AND %(trouble_type)s != %(crash_log_type)s)
      )
      AND (%(os_type)s = '' OR os_type = %(os_type)s)
    ORDER BY log_tm DESC, device_id DESC
    LIMIT %(limit_plus_one)s OFFSET %(offset)s
    ]]>
  </select>

  <select id="selectDeviceDistributionTroubleDetail">
    <![CDATA[
    SELECT
        log_tm AS logTm,
        device_id AS deviceId,
        user_id AS userId,
        log_type AS logType,
        os_type AS osType,
        os_ver AS osVer,
        app_ver AS appVer,
        device_model AS deviceModel,
        com_type AS comType,
        com_sensitivity AS comSensitivity,
        cpu_usage AS cpuUsage,
        mem_usage AS memUsage,
        battery_lvl AS batteryLvl,
        webview_ver AS webviewVer,
        app_build_num AS appBuildNum,
        req_url AS reqUrl,
        res_msg AS resMsg,
        intervaltime AS intervaltime,
        storage_usage AS storageUsage,
        storage_total AS storageTotal,
        timezone AS timezone,
        sim_operator_nm AS simOperatorNm,
        ip AS ip,
        page_id AS pageId
    FROM maxy_app_trouble_log
    WHERE package_nm = %(package_nm)s
      AND server_type = %(server_type)s
      AND log_tm = %(log_tm)s
      AND device_id = %(device_id)s
      AND mem_usage = %(mem_usage)s
    LIMIT 1
    ]]>
  </select>

  <select id="selectDeviceDistributionAllInfoList">
    <![CDATA[
    SELECT
        os_type AS osType,
        device_model AS deviceModel,
        uniqExactMerge(uniq_device_count) AS userCount,
        sumMerge(sum_error_count) AS errorCount,
        sumMerge(sum_crash_count) AS crashCount
    FROM maxy_model_hourly
    WHERE hour_bucket >= toDateTime(%(from_ts)s)
      AND hour_bucket <  toDateTime(%(to_ts)s)
      AND package_id = %(package_id)s
      AND server_type = %(server_type)s
      AND device_model != ''
      AND (%(os_type)s = '' OR os_type = %(os_type)s)
    GROUP BY
        os_type,
        device_model
    ORDER BY userCount DESC, deviceModel ASC
    LIMIT %(limit_plus_one)s OFFSET %(offset)s
    ]]>
  </select>

  <select id="selectDeviceDistributionAllInfoTotals">
    <![CDATA[
    SELECT
        sum(userCount) AS totalUsers,
        sum(errorCount) AS totalErrors,
        sum(crashCount) AS totalCrashes
    FROM (
        SELECT
            uniqExactMerge(uniq_device_count) AS userCount,
            sumMerge(sum_error_count) AS errorCount,
            sumMerge(sum_crash_count) AS crashCount
        FROM maxy_model_hourly
        WHERE hour_bucket >= toDateTime(%(from_ts)s)
          AND hour_bucket <  toDateTime(%(to_ts)s)
          AND package_id = %(package_id)s
          AND server_type = %(server_type)s
          AND device_model != ''
          AND (%(os_type)s = '' OR os_type = %(os_type)s)
        GROUP BY
            os_type,
            device_model
    )
    ]]>
  </select>

  <select id="selectDeviceDistributionAllRowInfoDay">
    <![CDATA[
    SELECT
        toUnixTimestamp(hour_bucket) * 1000 AS ts,
        uniqExactMerge(uniq_device_count) AS userCount,
        sumMerge(sum_error_count) AS errorCount,
        sumMerge(sum_crash_count) AS crashCount
    FROM maxy_model_hourly
    WHERE hour_bucket >= toDateTime(%(from_ts)s)
      AND hour_bucket <  toDateTime(%(to_ts)s)
      AND package_id = %(package_id)s
      AND server_type = %(server_type)s
      AND device_model = %(device_model)s
      AND (%(os_type)s = '' OR os_type = %(os_type)s)
    GROUP BY hour_bucket
    ORDER BY hour_bucket ASC
    ]]>
  </select>

  <select id="selectDeviceDistributionAllRowInfoRange">
    <![CDATA[
    SELECT
        toUnixTimestamp(toDateTime(log_date)) * 1000 AS ts,
        userCount,
        errorCount,
        crashCount
    FROM (
        SELECT
            toDate(hour_bucket) AS log_date,
            uniqExactMerge(uniq_device_count) AS userCount,
            sumMerge(sum_error_count) AS errorCount,
            sumMerge(sum_crash_count) AS crashCount
        FROM maxy_model_hourly
        WHERE hour_bucket >= toDateTime(%(from_ts)s)
          AND hour_bucket <  toDateTime(%(to_ts)s)
          AND package_id = %(package_id)s
          AND server_type = %(server_type)s
          AND device_model = %(device_model)s
          AND (%(os_type)s = '' OR os_type = %(os_type)s)
        GROUP BY log_date
    )
    ORDER BY log_date ASC
    ]]>
  </select>
</mapper>
