<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thinkm.maxy.mapper.DsymFileInfoMapper">

    <!-- DSYM 파일 정보 목록 조회 (전체 조회 및 조건별 검색 지원) -->
    <select id="selectDsymFileInfoList" parameterType="DsymFileInfoVO" resultType="DsymFileInfoVO">
        SELECT 
            package_nm,
            server_type,
            os_type,
            app_ver,
            app_build_num,
            app_name,
            uuid,
            file_name,
            file_path,
            reg_dt
        FROM 
            maxy_dsym_file_info
        <where>
            package_nm = #{packageNm}
            AND server_type = #{serverType}
        </where>
        ORDER BY 
            reg_dt DESC
    </select>

    <!-- 기존 DSYM 파일 정보 조회 (upsert 전 기존 파일 삭제용) -->
    <select id="selectExistingDsymFileInfo" parameterType="DsymFileInfoVO" resultType="DsymFileInfoVO">
        SELECT 
            package_nm,
            server_type,
            os_type,
            app_ver,
            app_build_num,
            app_name,
            uuid,
            file_name,
            file_path,
            reg_dt
        FROM 
            maxy_dsym_file_info
        WHERE 
            package_nm = #{packageNm}
            AND server_type = #{serverType}
            AND os_type = #{osType}
            AND app_ver = #{appVer}
            AND app_build_num = #{appBuildNum}
        LIMIT 1
    </select>

    <!-- DSYM 파일 정보 upsert -->
    <insert id="upsertDsymFileInfo" parameterType="DsymFileInfoVO">
        INSERT INTO maxy_dsym_file_info (
            package_nm,
            server_type,
            os_type,
            app_ver,
            app_build_num,
            app_name,
            uuid,
            file_name,
            file_path,
            reg_no,
            reg_dt
        ) VALUES (
            #{packageNm},
            #{serverType},
            #{osType},
            #{appVer},
            #{appBuildNum},
            #{appName},
            #{uuid},
            #{fileName},
            #{filePath},
            #{userNo},
            #{regDt}
        )
        ON DUPLICATE KEY UPDATE
            app_name = VALUES(app_name),
            uuid = VALUES(uuid),
            file_name = VALUES(file_name),
            file_path = VALUES(file_path),
            reg_no = VALUES(reg_no),
            reg_dt = VALUES(reg_dt)
    </insert>

    <!-- DSYM 파일 정보 삭제 -->
    <delete id="deleteDsymFileInfo" parameterType="DsymFileInfoVO">
        DELETE FROM maxy_dsym_file_info
        WHERE 
            package_nm = #{packageNm}
            AND server_type = #{serverType}
            AND os_type = #{osType}
            AND app_ver = #{appVer}
            AND app_build_num = #{appBuildNum}
    </delete>

</mapper>
