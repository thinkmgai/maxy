<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thinkm.maxy.mapper.UserGroupMapper">
    <!-- 사용자 그룹 목록 전체 조회 -->
    <select id="selectAllUserGroupList" resultType="UserGroupVO">
        select mug.grp_id,
               mug.up_grp_id,
               mug.grp_nm,
               mug.order_seq,
               mug.grp_level,
               mug.delete_yn,
               mug.full_order
        from (select t1.grp_id,
                     t1.up_grp_id,
                     t1.grp_nm,
                     t1.order_seq,
                     t1.grp_level,
                     t1.delete_yn,
                     t1.order_seq * 100 as full_order
              from maxy_user_group t1
              where t1.grp_level = '1'
              union all
              select t2.grp_id,
                     t2.up_grp_id,
                     t2.grp_nm,
                     t2.order_seq,
                     t2.grp_level,
                     t2.delete_yn,
                     (select order_seq
                      from maxy_user_group
                      where grp_id = t2.up_grp_id) * 100 + order_seq * 10 as full_order
              from maxy_user_group t2
              where t2.grp_level = '2'
              union all
              select t3.grp_id,
                     t3.up_grp_id,
                     t3.grp_nm,
                     t3.order_seq,
                     t3.grp_level,
                     t3.delete_yn,
                     (select order_seq
                      from maxy_user_group
                      where grp_id = (select up_grp_id
                                      from maxy_user_group
                                      where grp_id = t3.up_grp_id)) * 100 +
                     (select order_seq
                      from maxy_user_group
                      where grp_id = t3.up_grp_id) * 10 + order_seq as full_order
              from maxy_user_group t3
              where t3.grp_level = '3') mug
        where mug.delete_yn = 'N'
          and substring(mug.grp_id, 1, 2) > 0
        order by mug.full_order
    </select>

    <select id="selectAllUserGroupListByUserNo" resultType="UserGroupVO" parameterType="UserGroupVO">
        select mug.grp_id,
               mug.up_grp_id,
               mug.grp_nm,
               mug.order_seq,
               mug.grp_level,
               mug.delete_yn,
               mug.full_order
        from (select t1.grp_id,
                     t1.up_grp_id,
                     t1.grp_nm,
                     t1.order_seq,
                     t1.grp_level,
                     t1.delete_yn,
                     t1.order_seq * 100 as full_order
              from maxy_user_group t1
              where t1.grp_level = '1'
                and (t1.grp_id in (select grp_id from maxy_user_group_member where user_no = #{userNo})
                  or t1.up_grp_id in (select grp_id from maxy_user_group_member where user_no = #{userNo})
                  )
              union all
              select t2.grp_id,
                     t2.up_grp_id,
                     t2.grp_nm,
                     t2.order_seq,
                     t2.grp_level,
                     t2.delete_yn,
                     (select order_seq
                      from maxy_user_group
                      where grp_id = t2.up_grp_id) * 100 + order_seq * 10 as full_order
              from maxy_user_group t2
              where t2.grp_level = '2'
                and (t2.grp_id in (select grp_id from maxy_user_group_member where user_no = #{userNo})
                  or t2.up_grp_id in (select grp_id from maxy_user_group_member where user_no = #{userNo})
                  )
              union all
              select t3.grp_id,
                     t3.up_grp_id,
                     t3.grp_nm,
                     t3.order_seq,
                     t3.grp_level,
                     t3.delete_yn,
                     (select order_seq
                      from maxy_user_group
                      where grp_id = (select up_grp_id
                                      from maxy_user_group
                                      where grp_id = t3.up_grp_id)) * 100 +
                     (select order_seq
                      from maxy_user_group
                      where grp_id = t3.up_grp_id) * 10 + order_seq as full_order
              from maxy_user_group t3
              where t3.grp_level = '3'
                and (t3.grp_id in (select grp_id from maxy_user_group_member where user_no = #{userNo})
                  or t3.up_grp_id in (select grp_id from maxy_user_group_member where user_no = #{userNo})
                  )) mug
        where mug.delete_yn = 'N'
          and substring(mug.grp_id, 1, 2) > 0
        order by mug.full_order
    </select>

    <!-- 사용자 그룹 이름 수정 -->
    <update id="updateUserGroupNm" parameterType="UserGroupVO">
        update maxy_user_group
        set grp_nm = #{grpNm},
            upd_no = #{userNo},
            upd_dt = #{regDt}
        where grp_id = #{grpId}
    </update>

    <!-- 사용자 그룹 등록 -->
    <insert id="insertUserGroup" parameterType="UserGroupVO">
        insert into maxy_user_group (grp_id,
                                     up_grp_id,
                                     grp_nm,
                                     order_seq,
                                     grp_level,
                                     delete_yn,
                                     reg_no,
                                     reg_dt,
                                     upd_no,
                                     upd_dt)
        values (#{grpId},
                null,
                #{grpNm},
                #{orderSeq},
                1,
                'N',
                #{userNo},
                #{regDt},
                #{userNo},
                #{regDt})
    </insert>

    <!-- 사용자 자식 그룹 등록 -->
    <insert id="insertUserSubGroup" parameterType="UserGroupVO">
        insert into maxy_user_group (grp_id,
                                     up_grp_id,
                                     grp_nm,
                                     order_seq,
                                     grp_level,
                                     delete_yn,
                                     reg_no,
                                     reg_dt,
                                     upd_no,
                                     upd_dt)
        values (#{grpId},
                #{upGrpId},
                #{grpNm},
                #{orderSeq},
                2,
                'N',
                #{userNo},
                #{regDt},
                #{userNo},
                #{regDt})
    </insert>

    <!-- 사용자 그룹 메뉴 삭제 -->
    <update id="deleteUserGroup" parameterType="UserGroupVO">
        delete
        from maxy_user_group
        where grp_id = #{grpId}
           or up_grp_id = #{grpId}
    </update>

    <!-- 사용자 번호로 해당 사용자의 그룹 ID 수정 -->
    <update id="updateGrpIdByUserNo" parameterType="UserVO">
        update maxy_user_group_member
        set grp_id = #{grpId},
        upd_no = #{userNo},
        upd_dt = #{regDt}
        where user_no in
        <foreach collection="userNoList" separator="," item="item" open="(" close=")">
            #{item}
        </foreach>
    </update>

    <!-- 그룹 아이디로 사용자 번호 목록 조회 -->
    <select id="selectUserNoListByGrpId" resultType="long" parameterType="UserVO">
        select mugm.user_no as userNo
        from maxy_user_group_member mugm
                 inner join maxy_user_group mug on mugm.grp_id = mug.grp_id
                 inner join maxy_user mu on mu.user_no = mugm.user_no
        where (mugm.grp_id = #{grpId}
            or mug.up_grp_id = #{grpId})
          and mu.delete_yn = 'N'
    </select>

    <!-- 사용자 목록(시스템 관리자) 조회 -->
    <select id="selectUserList" resultType="UserVO" parameterType="UserVO">
        SELECT mu.user_no,
               mu.user_id,
               mu.user_nm,
               mu.email_addr,
               mu.expired_date,
               mu.reg_dt,
               mu.role_gbn,
               mu.pass_cnt,
               mugm.grp_id,
               mugm.admin_yn AS grpAdminYn,
               (SELECT COUNT(1)
                FROM maxy_app_package_user mapu
                         INNER JOIN maxy_app_package map
                                    ON mapu.package_nm = map.package_nm
                                        AND mapu.server_type = map.server_type
                WHERE mapu.user_no = mu.user_no
                  AND map.app_type = #{appType}
               )             AS appCount,
               mug.grp_nm
        FROM maxy_user mu
                 LEFT JOIN maxy_user_group_member mugm
                           ON mu.user_no = mugm.user_no
                 LEFT JOIN maxy_user_group mug
                           ON mugm.grp_id = mug.grp_id
        WHERE mu.delete_yn = 'N'
          AND mu.admin_yn = 'N'
        ORDER BY mu.user_no
    </select>

    <!-- 사용자 목록 조회 -->
    <select id="selectUserListInGroup" resultType="UserVO" parameterType="UserVO">
        SELECT mu.user_no,
               mu.user_id,
               mu.user_nm,
               mu.email_addr,
               mu.expired_date,
               mu.reg_dt,
               mu.role_gbn,
               mu.pass_cnt,
               mugm.grp_id,
               mugm.admin_yn                     AS grpAdminYn,
               (SELECT COUNT(1)
                FROM maxy_app_package_user mapu
                         INNER JOIN maxy_app_package map
                                    ON mapu.package_nm = map.package_nm
                                        AND mapu.server_type = map.server_type
                WHERE mapu.user_no = mu.user_no
                  AND map.app_type = #{appType}) AS appCount,
               mug.grp_nm
        FROM maxy_user mu
                 LEFT JOIN maxy_user_group_member mugm
                           ON mu.user_no = mugm.user_no
                 LEFT JOIN maxy_user_group mug
                           ON mugm.grp_id = mug.grp_id
        WHERE mu.delete_yn = 'N'
          AND mu.admin_yn = 'N'
          AND mugm.grp_id IN (SELECT grp_id
                              FROM maxy_user_group
                              WHERE grp_id = #{grpId}
                                 OR up_grp_id = #{grpId})
        ORDER BY mu.user_no
    </select>


    <!-- 모든 사용자 그룹 목록 조회 -->
    <select id="selectAllUpGroupNameList" resultType="UserGroupVO">
        select grp_id, grp_nm
        from maxy_user_group
        where (up_grp_id is null
            or up_grp_id = '')
          and delete_yn = 'N'
        union all
        select mug.grp_id,
               concat((select grp_nm
                       from maxy_user_group
                       where grp_id = mug.up_grp_id
                       limit 1), concat('>', mug.grp_nm))
        from maxy_user_group mug
        where (mug.up_grp_id is not NULL
            or mug.up_grp_id != '')
          and mug.delete_yn = 'N'
    </select>

    <!-- 사용자 그룹 목록 조회 -->
    <select id="selectAllUpGroupNameListInGroup" resultType="UserGroupVO" parameterType="UserVO">
        select grp_id, grp_nm
        from maxy_user_group
        where delete_yn = 'N'
          and grp_id = #{grpId}
        union all
        select mug.grp_id,
               concat((select grp_nm
                       from maxy_user_group
                       where grp_id = mug.up_grp_id
                       limit 1), concat('>', mug.grp_nm))
        from maxy_user_group mug
        where (mug.up_grp_id is not NULL
            or mug.up_grp_id != '')
          and mug.delete_yn = 'N'
          and mug.up_grp_id = #{grpId}
    </select>

    <!-- 유저 상세 수정 -->
    <update id="updateUserDetail" parameterType="UserVO">
        update maxy_user mu
        inner join maxy_user_group_member mugm
        on mu.user_no = mugm.user_no
        set mugm.grp_id = #{grpId},
        <choose>
            <when test='roleGbn == "0012"'>
                mugm.admin_yn = 'Y',
            </when>
            <otherwise>
                mugm.admin_yn = 'N',
            </otherwise>
        </choose>
        mu.role_gbn = #{roleGbn},
        mu.email_addr = #{emailAddr},
        mugm.upd_no = #{updNo},
        mugm.upd_dt = #{regDt},
        mu.upd_no = #{updNo},
        mu.upd_dt = #{regDt}
        where mu.user_no = #{userNo}
        and mugm.user_no = #{userNo}
    </update>

    <!-- 유저 상세 수정 -->
    <update id="updateUserUnlock" parameterType="UserVO">
        update maxy_user
        set pass_cnt     = 0,
            user_pw      = #{userPw},
            expired_date = #{expiredDate},
            upd_dt       = #{regDt},
            upd_no       = #{updNo}
        where user_no = #{userNo}
    </update>

    <!--  user 상세 조회  -->
    <select id="selectUserDetail" resultType="UserVO" parameterType="UserVO">
        select mu.user_no,
               mu.user_id,
               mu.user_nm,
               mu.email_addr,
               mu.admin_yn,
               mu.role_gbn,
               mugm.grp_id
        from maxy_user mu
                 inner join maxy.maxy_user_group_member mugm on mu.user_no = mugm.user_no
        where mu.user_no = #{userNo}
          and mu.delete_yn = 'N'
    </select>

    <!-- 유저 등록 -->
    <insert id="insertRegUser" parameterType="UserVO">
        insert into maxy_user
        (user_no,
         user_id,
         user_pw,
         pass_cnt,
         user_nm,
         email_addr,
         phone_no,
         expired_date,
         admin_yn,
         delete_yn,
         reg_no,
         reg_dt,
         upd_no,
         upd_dt,
         role_gbn)
        values ((select max(mu.user_no) + 1 from maxy_user mu),
                #{userId},
                #{userPw},
                0,
                #{userNm},
                #{emailAddr},
                #{phoneNo},
                #{expiredDate},
                'N',
                'N',
                #{regNo},
                #{regDt},
                #{regNo},
                #{regDt},
                #{roleGbn})
    </insert>

    <!-- 등록한 유저 아이디 삭제처리된 유저가 있는지 조회 -->
    <select id="checkExistUser" parameterType="UserVO" resultType="UserVO">
        select user_id
             , user_no
             , delete_yn
        from maxy_user
        where user_id = #{userId}
    </select>

    <update id="updateDeleteUser" parameterType="UserVO">
        update maxy_user
        set user_pw = #{userPw},
        pass_cnt = 0,
        user_nm = #{userNm},
        email_addr = #{emailAddr},
        phone_no = #{phoneNo},
        expired_date = #{expiredDate},
        <choose>
            <when test='roleGbn == "0011"'>
                admin_yn = 'Y',
            </when>
            <otherwise>
                admin_yn = 'N',
            </otherwise>
        </choose>
        role_gbn = #{roleGbn},
        delete_yn = 'N',
        upd_no = #{regNo},
        upd_dt = #{regDt}
        where user_id = #{userId}
        and delete_yn = 'Y'
    </update>

    <!-- 등록한 유저 아이디로 유저 번호 조회 -->
    <select id="selectInsertedUserNoByUserId" parameterType="UserVO" resultType="long">
        select user_no
        from maxy_user
        where user_id = #{userId}
    </select>

    <!-- 유저 그룹 멤버에 유저 등록 -->
    <insert id="insertRegUserGroupMember" parameterType="UserVO">
        replace into maxy_user_group_member
        (grp_id,
         user_no,
         admin_yn,
         reg_no,
         reg_dt,
         upd_no,
         upd_dt)
        values (#{grpId},
                #{userNo},
                #{grpAdminYn},
                #{userNo},
                #{regDt},
                #{regNo},
                #{regDt})
    </insert>

    <!-- 유저 삭제 -->
    <update id="deleteUser" parameterType="UserVO">
        update maxy_user
        set delete_yn = 'Y',
            upd_no    = #{updNo},
            upd_dt    = #{regDt}
        where user_no = #{userNo}
    </update>

    <!-- 그룹 내 유저 삭제 -->
    <update id="deleteUserGroupMemberByUserNo" parameterType="UserVO">
        delete
        from maxy_user_group_member
        where user_no = #{userNo}
    </update>

    <select id="selectAllAppListByUserNo" resultType="UserVO" parameterType="UserVO">
        SELECT
            a.package_nm,
            a.server_type,
            map.app_type,
            IF(b.package_nm IS NOT NULL, 'Y', 'N') AS picked
        FROM (
                 SELECT DISTINCT
                     mapu.package_nm,
                     mapu.server_type
                 FROM maxy_app_package_user mapu
                 WHERE mapu.use_yn = 'Y'
             ) a
                 LEFT JOIN (
            SELECT
                mapu.package_nm,
                mapu.server_type
            FROM maxy_app_package_user mapu
            WHERE mapu.user_no = #{userNo}
              AND mapu.use_yn = 'Y'
        ) b
                           ON a.package_nm = b.package_nm
                               AND a.server_type = b.server_type
                 INNER JOIN maxy_app_package map
                            ON map.package_nm = a.package_nm
                                AND map.server_type = a.server_type
        WHERE map.app_type = #{appType}
        ORDER BY a.package_nm, a.server_type
    </select>

    <select id="selectAppListByLoginUser" resultType="UserVO" parameterType="UserVO">
        SELECT DISTINCT
            mapu.package_nm,
            mapu.server_type,
            map.app_type
        FROM maxy_app_package_user mapu
                 INNER JOIN maxy_app_package map
                            ON map.package_nm = mapu.package_nm
                                AND map.server_type = mapu.server_type
        WHERE mapu.user_no IN (
            SELECT mugm.user_no
            FROM maxy_user_group_member mugm
            WHERE mugm.admin_yn = 'Y'
              AND mugm.grp_id IN (
                SELECT grp_id
                FROM maxy_user_group_member
                WHERE user_no = #{updNo}
            )
        )
          AND map.app_type = #{appType}
    </select>

    <select id="selectAppListByUser" resultType="UserVO" parameterType="UserVO">
        SELECT
            mapu.package_nm,
            mapu.server_type,
            map.app_type
        FROM maxy_app_package_user mapu
                 INNER JOIN maxy_app_package map
                            ON map.package_nm = mapu.package_nm
                                AND map.server_type = mapu.server_type
        WHERE mapu.user_no = #{userNo}
          AND mapu.use_yn = 'Y'
          AND map.app_type = #{appType}
    </select>

    <select id="selectAllUserListByApp" resultType="UserVO" parameterType="UserVO">
        select mu.user_nm, mu.user_id, mu.email_addr
        from maxy_user mu
                 left join maxy.maxy_app_package_user mapu on mu.user_no = mapu.user_no
        where mapu.package_nm = #{packageNm}
          and mapu.server_type = #{serverType}
          and mu.delete_yn = 'N'
          and mapu.use_yn = 'Y'
        order by mu.user_id
    </select>

    <select id="selectUserListByApp" resultType="UserVO" parameterType="UserVO">
        select mu.user_nm, mu.user_id, mu.email_addr
        from maxy_user mu
                 left join maxy.maxy_app_package_user mapu on mu.user_no = mapu.user_no
        where mu.user_no in (SELECT user_no
                             FROM maxy_user_group_member mugm
                             WHERE grp_id IN (SELECT grp_id
                                              FROM maxy_user_group
                                              WHERE (grp_id IN
                                                     (SELECT grp_id FROM maxy_user_group_member WHERE user_no = #{userNo})
                                                  OR up_grp_id IN
                                                     (SELECT grp_id FROM maxy_user_group_member WHERE user_no = #{userNo}))))
          and mapu.package_nm = #{packageNm}
          and mapu.server_type = #{serverType}
          and mu.delete_yn = 'N'
          and mapu.use_yn = 'Y'
        order by mu.user_id
    </select>


    <select id="selectAppPackageServerList" resultType="PackageVO">
        select map.server_type,
               map.package_nm,
               map.use_yn,
               map.server_type,
               map.`order`
        from maxy_app_package map
        where map.use_yn = 'Y'
        order by map.`order`
    </select>

    <select id="selectAllAppUserCount" resultType="PackageVO" parameterType="UserVO">
        SELECT a.*
        FROM (SELECT map.package_nm,
                     CASE
                         WHEN map.server_type = 0 THEN 'dev'
                         WHEN map.server_type = 1 THEN 'qa'
                         WHEN map.server_type = 2 THEN 'prod'
                         ELSE 'unknown'
                         END  AS server_type,
                     map.app_type,
                     COUNT(1) AS user_count,
                     map.`order`
              FROM maxy_user mu
                       INNER JOIN maxy_app_package_user mapu ON mu.user_no = mapu.user_no
                  AND mapu.use_yn = 'Y'
                       INNER JOIN maxy_app_package map ON BINARY (mapu.package_nm) = BINARY (map.package_nm)
                  AND mapu.server_type = map.server_type
                  AND map.use_yn = 'Y'
              WHERE mu.delete_yn = 'N'
                AND map.app_type = #{appType}
              GROUP BY map.server_type, map.package_nm) a
        ORDER BY a.`order`;
    </select>

    <select id="selectAppUserCountByGroup" resultType="PackageVO" parameterType="UserVO">
        SELECT map.package_nm,
               CASE
                   WHEN map.server_type = 0 THEN 'dev'
                   WHEN map.server_type = 1 THEN 'qa'
                   WHEN map.server_type = 2 THEN 'prod'
                   ELSE 'unknown'
                   END                                                                                      AS server_type,
               map.`order`,
               map.app_type,
               (SELECT COUNT(1)
                FROM maxy_app_package_user mapu
                WHERE BINARY (map.package_nm) = BINARY (mapu.package_nm)
                  AND map.server_type = mapu.server_type
                  AND mapu.use_yn = 'Y'
                  AND mapu.user_no IN (SELECT user_no
                                       FROM maxy_user_group_member mugm
                                       WHERE grp_id IN (SELECT grp_id
                                                        FROM maxy_user_group
                                                        WHERE (grp_id IN (SELECT grp_id
                                                                          FROM maxy_user_group_member
                                                                          WHERE user_no = #{userNo}) OR
                                                               up_grp_id IN (SELECT grp_id
                                                                             FROM maxy_user_group_member
                                                                             WHERE user_no = #{userNo}))))) AS user_count
        FROM maxy_app_package map
                 INNER JOIN maxy_app_package_user mapu
                            ON BINARY (map.package_nm) = BINARY (mapu.package_nm)
                                AND map.server_type = mapu.server_type
                                AND mapu.use_yn = 'Y'
                                AND mapu.user_no = #{userNo}
        WHERE map.app_type = #{appType}
        ORDER BY map.`order`;
    </select>

    <select id="selectNoneAppPackageUserCount" resultType="int">
        select count(1) user_count
        from maxy_user mu
                 left outer join maxy_app_package_user mapu
                                 on mu.user_no = mapu.user_no
                                     and mapu.use_yn = 'Y'
        where mapu.package_nm is null
          and mu.delete_yn = 'N'
    </select>

    <select id="selectPackageCount">
        select count(1)
        from maxy_app_package
        where server_type = #{serverType}
          and use_yn = 'y';
    </select>

    <select id="selectUserNmAndEmailAddrByUserId" resultType="UserVO" parameterType="UserVO">
        select email_addr,
               user_nm
        from maxy_user
        where user_id = #{userId}
          and delete_yn = 'N'
    </select>

    <select id="selectUserIdByUserNo" resultType="UserVO" parameterType="UserVO">
        select user_id
        from maxy_user
        where user_no = #{userNo}
          and delete_yn != 'Y'
        limit 1
    </select>

    <update id="deleteAppGrantByUserNo" parameterType="UserVO">
        delete
        from maxy_app_package_user
        where user_no = #{userNo}
    </update>

    <update id="updateUserAppGrant" parameterType="UserVO">
        insert into maxy_app_package_user (
        package_nm,
        server_type,
        user_no,
        reg_dt,
        reg_no,
        upd_dt,
        upd_no)
        values
        <foreach collection="appInfoList" item="item" separator=",">
            (#{item.packageNm}
            , #{item.serverType}
            , #{userNo}
            , #{regDt}
            , #{updNo}
            , #{regDt}
            , #{updNo})
        </foreach>
    </update>

    <select id="existAppGrantByUserNo" parameterType="UserVO" resultType="int">
        SELECT count(1)
        FROM maxy_app_package_user mapu
                 left outer join (select mapu.package_nm, mapu.server_type
                                  from maxy_app_package_user mapu
                                  where user_no = #{userNo}) b on mapu.package_nm = b.package_nm
            and mapu.server_type = b.server_type
        WHERE user_no IN (SELECT mugm.user_no
                          FROM maxy_user_group_member mugm
                          WHERE mugm.admin_yn = 'Y'
                            and grp_id in (select grp_id
                                           from maxy_user_group_member
                                           where user_no = #{userNo}))
          and mapu.package_nm = #{packageNm}
          and mapu.server_type = #{serverType}
    </select>

    <select id="existUpGrpByUserNo" parameterType="UserVO" resultType="UserVO">
        select up_grp_id
        from maxy_user_group mug
        where mug.grp_id = (select mugm.grp_id from maxy_user_group_member mugm where user_no = #{userNo})
    </select>

    <select id="existUpGroupAppInfoByUpGrpId" parameterType="UserVO" resultType="int">
        select count(1)
        from maxy_app_package_user
        where user_no in (select user_no from maxy_user_group_member where grp_id = #{upGrpId})
          and package_nm = #{packageNm}
          and server_type = #{serverType}
          and use_yn = 'Y'
    </select>

    <select id="selectMaxGroupId" resultType="UserGroupVO">
        SELECT MAX(SUBSTRING(grp_id, 1, 5)) as max_grp_id,
               order_seq
        FROM maxy_user_group
        group by order_seq
        order by max_grp_id desc
        limit 1
    </select>

    <select id="selectMaxSubGroupId" resultType="UserGroupVO">
        SELECT MAX(SUBSTRING(grp_id, 6, 11)) as max_grp_id,
               order_seq
        FROM maxy_user_group
        where up_grp_id = #{upGrpId}
        group by order_seq
        order by max_grp_id desc
        limit 1
    </select>
</mapper>